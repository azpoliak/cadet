<!DOCTYPE html>
<html lang="en">
<head>
    <title>Concrete Search UI</title>
    <meta charset='UTF-8'>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="css/buttons.dataTables.min.css" rel="stylesheet">
    <script src="js/jquery-1.11.1.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/dataTables.buttons.min.js"></script>
    <script src="js/buttons.colVis.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/thrift.js"></script>
    <script src="js/concrete.js"></script>
    <script src="js/concrete-widgets.js"></script>
    <script src="js/concrete-services.js"></script>
    <script src="js/cadet.js"></script>
    <style>
    img {
        margin:10px 5px;
    }
    mark {
        font-weight: bold;
    }

    .communication .entity_mention {
        background-color: Linen;
        cursor: pointer;
    }

    .search_result_text {
        cursor: pointer;
    }

    .communication .sentence {
        display: inline;
    }
    .communication .tokenization {
        display: inline;
    }
    .section + .section {
        padding-bottom: 1em;
    }
    </style>
    <script>
    /* globals AnnotationTaskType, CADET, SearchFeedback, SearchQuery,
               SearchType */

    // Global variables
    var SEARCH_RESULT_TABLE;
    var SEARCH_RESULTS;

    function createResultsTable() {
        SEARCH_RESULT_TABLE = $('#results_table').DataTable({
            buttons: [
                {
                    action: function (e, dt, node, config, results) {
                        CADET.registerSearchResultWithGuard(SEARCH_RESULTS);
                    },
                    text: 'Export'
                },
                {
                    extend: 'colvis',
                    text:'Toggle Columns'
                }
            ],
            columns: [
                {
                    title: 'Feedback',
                    className: 'feedback_buttons',
                    render: function(data, type, searchResult) {
                        return '';
                    },
                    sortable: false,
                    width: '1%'
                },
                {
                    title: 'Communication ID',
                    render: function(data, type, searchResult) {
                        return searchResult.communicationId;
                    },
                    visible: false
                },
                {
                    title: 'Sentence ID',
                    render: function(data, type, searchResult) {
                        if (searchResult.sentenceId) {
                            return searchResult.sentenceId.uuidString;
                        }
                        else {
                            return '';
                        }
                    },
                    visible: false
                },
                {
                    title: 'Score',
                    render: function(data, type, searchResult) {
                        return searchResult.score;
                    },
                    visible: false
                },
                {
                    title: 'Text',
                    className: 'search_result_text',
                    render: function(data, type, searchResult) {
                        if (type === 'display') {
                            // The render function can be called multiple times.  We only retrieve
                            // the Communication when the render type is 'display'
                            //   https://datatables.net/reference/option/columns.render
                            try {
                                var retrieveResults = CADET.retrieveComms([searchResult.communicationId]);
                                if (retrieveResults.communications.length === 1) {
                                    searchResult.communication = retrieveResults.communications[0];
                                    searchResult.communication.addInternalReferences();

                                    // searchResult.sentence will be null if searchResult.sentenceId is not valid
                                    searchResult.sentence = searchResult.communication.getSentenceWithUUID(
                                        searchResult.sentenceId);
                                }
                            }
                            catch (error) {
                                displayAndThrowError(error);
                            }

                            var searchResultText = '';

                            if (searchResult.sentence) {
                                searchResultText = $('<span>').sentenceWidget(searchResult.sentence).text();
                            }
                            else {
                                if (searchResult.sentenceId) {
                                    console.error('SearchResult specified an invalid sentenceId');
                                }
                                else {
                                    displayErrorMessage('SearchResult did not include an (optional) sentenceId');
                                    console.warn('SearchResult did not include an (optional) sentenceId');
                                }

                                var firstSentence = getFirstSentenceInCommunication(searchResult.communication);
                                if (firstSentence) {
                                    searchResultText = $('<span>').sentenceWidget(firstSentence).text();
                                }
                                else if (!searchResult.communication) {
                                    searchResultText = '<div class="alert alert-danger" role="alert" ' +
                                                       'style="font-style: italic">' +
                                                       'Unable to retrieve Communication for this SearchResult' +
                                                       '</div>';
                                }
                                else {
                                    console.warn('Communication did not contain any Sentences');
                                    searchResultText = searchResult.communication.text;
                                }
                            }

                            return searchResultText;
                        }
                        else { // type !== 'display'
                            return '';
                        }
                    }
                }
            ],
            createdRow: function(row, searchResult, index) {
                // Add event handlers to DOM elements created by render()
                //
                // For more information about how to use DataTables' createdRow, see:
                //   https://datatables.net/examples/advanced_init/row_callback.html

                $('.feedback_buttons', row).append(
                    // Feedback button group
                    $('<div>')
                        .addClass('btn-group')
                        .attr('data-toggle', 'buttons')
                        .append(
                            // Positive feedback button
                            $('<label>')
                                .addClass('btn btn-default btn-sm glyphicon glyphicon-ok feedback')
                                .attr('data-polarity', 'pos')
                                .append(
                                    $('<input>')
                                        .attr('type', 'radio')
                                        .attr('autocomplete', 'off'))
                                .on('click',
                                    {'searchResult': searchResult, 'searchResults': SEARCH_RESULTS},
                                    saveSentenceFeedback))
                        .append(
                            // Negative feedback button
                            $('<label>')
                                .addClass('btn btn-default btn-sm glyphicon glyphicon-remove feedback')
                                .attr('data-polarity', 'neg')
                                .append(
                                    $('<input>')
                                        .attr('type', 'radio')
                                        .attr('autocomplete', 'off'))
                                .on('click',
                                    {'searchResult': searchResult, 'searchResults': SEARCH_RESULTS},
                                    saveSentenceFeedback)));

                var searchResultId = SEARCH_RESULTS.uuid.uuidString + '_' + index;
                $('.search_result_text', row).attr('id', searchResult.communicationId)
                   .on('click',
                       {
                           'searchResult': searchResult,
                           'searchResultId': searchResultId,
                       },
                       openSearchResultTab);
            },

            // The deferRender option allows "lazy loading" of Communications via retrieve()
            //   https://datatables.net/examples/ajax/defer_render.html
            deferRender: true,

            // The options for 'dom' are documented here:
            //   https://datatables.net/reference/option/dom
            // We are currently using the options:
            //   B - Buttons
            //   r - processing display element
            //   t - table
            //   i - table information summary
            //   p - pagination control
            dom: 'Brtip',
            language: {
                emptyTable: 'No matching search results'
            },
        });
    }

    /**
     */
    function createEntityMentionSearchMenu(event) {
        var searchResult = event.data.searchResult;

        var entityMentionList = [];
        for (var i = 0; i < this.classList.length; i++) {
            if (this.classList[i].startsWith('entity_mention_')) {
                var entityMentionId = this.classList[i].substring(15);
                var entityMention = searchResult.communication.getEntityMentionWithUUID({
                    'uuidString': entityMentionId
                });
                entityMentionList.push(entityMention);
            }
        }

        var entityMentionListDiv = $('<div>');
        var tokenIndexSet = {};
        for (var j = 0; j < entityMentionList.length; j++) {
            var searchQuery = new SearchQuery();
            searchQuery.type = SearchType.ENTITY_MENTIONS;
            searchQuery.communicationId = searchResult.communicationId;
            searchQuery.tokens = entityMentionList[j].tokens;
            searchQuery.userId = CADET.userId;

            // TODO: Modify src/main/java/edu/jhu/hlt/concrete/search/SearchHandler.java
            //       to not throw exceptions if rawQuery or terms are empty.
            searchQuery.terms = ["IGNORED"];
            searchQuery.rawQuery = "IGNORED";

            // Only add one list item per set of tokens.  A Communication may have multiple
            // EntityMentionSets, and so may have multiple EntityMentions that point to
            // the same set of tokens.
            if (!tokenIndexSet.hasOwnProperty(searchQuery.tokens.tokenIndexList)) {
                tokenIndexSet[searchQuery.tokens.tokenIndexList] = true;

                entityMentionListDiv.append(
                    $('<li>').append(
                        $('<a>')
                            .css('cursor', 'pointer')
                            .on('click', {'searchQuery': searchQuery}, executeSearchQueryFromEntityMention)
                            .text(entityMentionList[j].text)));
            }
        }

        if ($(this).hasClass('popover_entity_mention_search')) {
            // Remove the current popover
            $(this).popover('destroy');
            $(this).removeClass('popover_entity_mention_search');
        }
        else {
            // Remove all popovers
            $(this).closest('.communication').find('.popover_entity_mention_search').popover('destroy');

            // Add and show new popover
            $(this).addClass('popover_entity_mention_search');
            $(this).popover({
                'content': entityMentionListDiv,
                'html': true,
                'placement': 'auto',
                'title': 'Entity Mention Search'
            });
            $(this).popover('show');
        }
    }

    function addResultsToResultsTable(searchResults) {
        SEARCH_RESULTS = searchResults;
        SEARCH_RESULT_TABLE.clear();
        if (searchResults.searchResults.length > 0) {
            SEARCH_RESULT_TABLE.rows.add(searchResults.searchResults);
        }
        SEARCH_RESULT_TABLE.draw();
    }

    function displayAndThrowError(error) {
        displayErrorMessage(error.message);
        throw error;
    }

    function displayErrorMessage(message) {
        $('#errors').html('<div class="alert alert-danger" role="alert">' + message + '</div>');
    }

    function executeSearchQuery(searchQuery) {
        // removes any previous error messages
        $('#errors').empty();

        var searchResults;
        try {
            searchResults = CADET.search.search(searchQuery);
        }
        catch (error) {
            displayAndThrowError(error);
        }

        addResultsToResultsTable(searchResults);

        $('a[href="#search_results"]').tab('show');
    }

    function executeSearchQueryEventHandler(event) {
        executeSearchQuery(event.data.searchQuery);
    }

    function executeSearchQueryFromEntityMention(event) {
        // Remove all popovers
        $(this).closest('.communication').find('.popover_entity_mention_search').popover('destroy');

        executeSearchQuery(event.data.searchQuery);
    }

    function executeSearchQueryFromSearchBox() {
        var searchInput = document.getElementById('user_search').value;
        var queryName =   document.getElementById('query_name').value;

        executeSearchQuery(CADET.createSearchQueryFromSearchString(searchInput, queryName));
    }

    /** Return the EntityMentionSet in the Communication with the specified toolname
     * @param {Communication} communication
     * @param {String} toolname
     * @returns {EntityMentionSet|null}
     */
    function getEntityMentionSetWithToolname(communication, toolname) {
        if (communication && communication.entityMentionSetList && communication.entityMentionSetList.length > 0) {
            for (var i = 0; i < communication.entityMentionSetList.length; i++) {
                if (communication.entityMentionSetList[i].metadata.tool === toolname) {
                    return communication.entityMentionSetList[i];
                }
            }
        }
        return null;
    }

    /** Return the first Sentence in a Communication, or null
     * @param {Communication} communication
     * @returns {Sentence|null}
     */
    function getFirstSentenceInCommunication(communication) {
        if (communication) {
            // The first few Sections may be empty, so we need to iterate over Sections
            if (communication.sectionList && communication.sectionList.length) {
                for (var i = 0; i < communication.sectionList.length; i++) {
                    if (communication.sectionList[i].sentenceList &&
                        communication.sectionList[i].sentenceList.length)
                    {
                        return communication.sectionList[i].sentenceList[0];
                    }
                }
            }
        }
        return null;
    }

    /** Create a new tab containing the Communication text for a search result
     */
    function openSearchResultTab(event) {
        var searchResult = event.data.searchResult;
        var searchResultId = event.data.searchResultId;

        // Add tab with Communication ID as title and an 'X' button for closing the tab
        $('#nav-tabs').append(
            $('<li>').append(
                $('<a>').attr('data-toggle', 'tab')
                        .attr('href', '#' + searchResultId)
                        .text(searchResult.communicationId)
                        .append(
                            // We are embedding the <span> with the remove ('X') link *in* the
                            // <a> link because of Bootstrap CSS rules that use the selectors
                            // ".nav-tabs>li>a" and ".nav>li>a".
                            $('<span>')
                                .addClass('glyphicon glyphicon-remove')
                                .css('margin-left', '0.5em')
                                .on('click', {'searchResultId': searchResultId}, function(event) {
                                    // Remove the <div> with the tab content
                                    $('#' + event.data.searchResultId).remove();
                                    // Remove the tab
                                    $(this).closest('li').remove();
                                    // Show the Search Results tab
                                    $('a[href="#search_results"]').tab('show');
                                }))));

        $('#tab-content').append('<div id="' + searchResultId +'" class="tab-pane"></div>');

        // Add content to <div> for the newly created tab
        if (getFirstSentenceInCommunication(searchResult.communication)) {
            // communicationWidget() will only render text if the Communication has Sentences
            var communicationDiv = $('<div>').communicationWidget(searchResult.communication);
            $('div #' + searchResultId).append(communicationDiv);

            // The Kelvin KB is built using Serif EntityMentions
            var serifMentionEMS = getEntityMentionSetWithToolname(searchResult.communication, "Serif: mentions");
            if (serifMentionEMS) {
                communicationDiv.addEntityMentionSet(serifMentionEMS);
            }
//            communicationDiv.addAllEntityMentionsInCommunication(searchResult.communication);

            communicationDiv.find('.entity_mention').on(
                'click',
                {'searchResult': searchResult},
                createEntityMentionSearchMenu
            );
            if (searchResult.sentence) {
                communicationDiv.getSentenceElements(searchResult.sentence)
                                .css('background-color', 'yellow');
            }
        }
        else {
            // If the Communication does not have Sentences, just display the .text field
            $('div #' + searchResultId).append($('<div>').text(searchResult.communication.text));
        }

        $('a[href="#'+ searchResultId +'"]').tab('show');
    }

    /** Interactively prompt user for login name until a non-empty string is entered.
     *  The CADET.userId variable is set to the string that the user enters.
     */
    function promptForLoginName() {
        var userId = prompt('Please input your user ID:');
        if (typeof userId === 'string') {
            if (userId!=='') {
                $('#greeting').text('Hello, ' + userId);
                CADET.userId = userId;
            }
        }
    }

    function saveSentenceFeedback(event) {
        var searchResult = event.data.searchResult;
        var searchResults = event.data.searchResults;
        var searchResultsId = searchResults.uuid;
        var communicationId = searchResult.communicationId;
        var sentenceId = searchResult.sentenceId;

        var feedback;
        if ($(this).data('polarity')==='pos'){
            feedback = SearchFeedback.POSITIVE;
        }
        else {
            feedback = SearchFeedback.NEGATIVE;
        }

        try {
            CADET.startFeedbackWithGuard(searchResults);
            CADET.feedback.addSentenceFeedback(searchResultsId, communicationId, sentenceId, feedback);
        }
        catch (error) {
            displayAndThrowError(error);
        }
    }

    function updateServiceStatus() {
        var services = ['search', 'retriever', 'feedback'];
        var serviceStatusMessage = '';
        var unavailableServices = [];

        for (var index in services) {
            try {
                if (!CADET[services[index]].alive()) {
                    unavailableServices.push(services[index]);
                    serviceStatusMessage += '<li>The ' + services[index] + ' service is not alive</li>';
                }
            }
            catch (error) {
                unavailableServices.push(services[index]);
                serviceStatusMessage += '<li>Error when trying to connect to ' + services[index] + ' service: ' +
                                        error.name + ' - ' + error.message +
                                        '</li>';
            }
        }
        if (unavailableServices.length > 0) {
            displayErrorMessage(serviceStatusMessage);
        }
    }

    // initialize all CADET clients
    CADET.init();

    $(document).ready(function() {
        updateServiceStatus();

        $('#greeting').on('click', promptForLoginName);

        // search box is focused on pageload
        $('#user_search').focus();

        // press enter key to trigger search button click handler
        $('#user_search, #query_name').bind('keypress', function(e) {
            if (e.keyCode===13) {
                executeSearchQueryFromSearchBox();
            }
        });

        createResultsTable();

        $('#search_button').on('click', executeSearchQueryFromSearchBox);
    });
    </script>
</head>
<body>
    <div class="container-fluid">
        <h4>
            <a href="results.html">Results</a>
        </h4>
        <span id="greeting" class="pull-right label label-primary" style="margin:5px">Login</span>
        <div class="row">
            <img src="img/logo.png" alt="Human Language Technology Center of Excellence">
        </div>
        <div class="row">
            <input name="query" id="user_search" type="text" style="width:50%" placeholder="Search...">
            <input id="query_name" type="text" style="width:50%" placeholder="Query Name">
            <button class="btn btn-primary glyphicon glyphicon-search" id="search_button"></button>
        </div>
        <div id="errors"></div>
        <ul id="nav-tabs" class="nav nav-tabs">
            <li><a data-toggle="tab" href="#markup">Instructions</a></li>
            <li class="active"><a data-toggle="tab" href="#search_results">Search Results</a></li>
        </ul>
        <div id="tab-content" class="tab-content">
            <div id="markup" class="tab-pane">
                <table class="table">
                    <tr>
                        <th><h4>Question <small>a natural language question</small></h4></th>
                        <th><h4>Term <small>a single word</small></h4></th>
                        <th><h4>Phrase <small>a group of words</small></h4></th>
                    </tr>
                    <tr>
                        <td><mark>?:"</mark>Where is the HLTCOE?<mark>"</mark></td>
                        <td>HLTCOE</td>
                        <td><mark>"</mark>Human Language Technology Center of Excellence<mark>"</mark></td>
                    </tr>
                    <tr>
                        <td><mark>?:"</mark>What is the largest city in Maryland?<mark>"</mark></td>
                        <td>Baltimore</td>
                        <td><mark>"</mark>population of Maryland<mark>"</mark></td>
                    </tr>
                    <tr>
                        <td><mark>?:"</mark>When did Apollo 11 land on the moon?<mark>"</mark></td>
                        <td>1969</td>
                        <td><mark>"</mark>Neil Armstrong<mark>"</mark></td>
                    </tr>
                </table>
            </div>
            <div id="search_results" class="tab-pane active">
                <table id="results_table" class="display"></table>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</body>
</html>
