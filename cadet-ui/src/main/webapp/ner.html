<!DOCTYPE html>
<html lang="en">
<head>
    <title>Concrete NER UI</title>
    <meta charset='UTF-8'>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
    .container-fluid {
        margin-left: 1em;
        margin-right: 1em;
    }

    .tag_text_li {
        display: inline;
    }
    .tag_text_input {
        margin-right: 1em;
        width: 8em;
    }

    .token_tagging_container {
        border: 1px solid 888;
        padding-bottom: 2em;
    }

    /** Hide tokenTags. This can be commented out for debugging purposes.**/
    .tokenTag {
        display: none;
    }

     /** Create classes for BIO tags. **/
    .token_tag_type_B {
        cursor: pointer;
        font-weight: bold
    }
    .token_tag_type_I {
        cursor: pointer;
        font-style: italic
    }
    .token_tag_type_O {
        cursor: pointer;
    }
    </style>
    <script src="js/jquery-1.11.1.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/thrift.js"></script>
    <script src="js/concrete.js"></script>
    <script src="js/cadet.js"></script>
    <script src="js/tokentagging_ui.js"></script>
    <script>

    function addTagTextBox(tagIndex) {
        $('#tag_type_list').append(
            $('<li>').addClass('tag_text_li')
                     .append(
                         $('<input>').addClass('tag_text_input')
                                     .attr('type', 'text')
                                     .change({'tagSet': tagSet, 'tagIndex':tagIndex}, function(event) {
                                         event.data.tagSet[event.data.tagIndex] = $(this).val();
                                     })
                                     .val(tagSet[tagIndex])));
    }

    /** Takes an AnnotationUnitIdentifier list, returns a list of Communications.
     *  Adds an 'annotationUnitIdentifier' field to each retrieved Communication.
     *
     * @param {AnnotationUnitIdentifier list} annotationUnitIdentifiers
     * @returns {Communication list}
     */
    function getNextCommunications(annotationUnitIdentifiers) {
        if (annotationUnitIdentifiers.length === 0) {
            return [];
        }

        var communicationIdToAUI = {};
        var fetchRequest = new FetchRequest({'communicationIds': []});
        for (var i = 0; i < annotationUnitIdentifiers.length; i++) {
            fetchRequest.communicationIds.push(annotationUnitIdentifiers[i].communicationId)
            communicationIdToAUI[annotationUnitIdentifiers[i].communicationId] = annotationUnitIdentifiers[i];
        }
        var fetchResults = CADET.fetch.fetch(fetchRequest);

        for (var j = 0; j < fetchResults.communications.length; j++) {
            fetchResults.communications[j].annotationUnitIdentifier =
                communicationIdToAUI[fetchResults.communications[j].id];
        }

        return fetchResults.communications;
    }

    function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    }

    function saveCommsToFormData() {
        // HACK: tokentagging_ui.js calls saveCommsToFormData() whenever a token tag changes.
        // TODO: Refactor tokentagging_ui.js (which also exists in the NER_HIT repository)
    }

    function updateDisplayedCommunications(comms) {
        $('#tokenization_list').empty();

        for (var commIndex = 0; commIndex < comms.length; commIndex++) {
            var comm = comms[commIndex];

            var tokensDiv = $('<div>').attr('id', 'comm_' + commIndex + '_tokens');
            var tokenTagInputsDiv = $('<div>').attr('id', 'comm_' + commIndex + '_ne_inputs');

            var tokenization = getFirstTokenization(comm);
            var tokenTaggingIndex = checkForPreviousNERTags(tokenization);
            if (tokenization) {
                // If there is a previous NER TokenTagging, it is duplicated.
                if (tokenTaggingIndex !== false) {
                    var tokenTagging = duplicateTokenTagging(tokenization, tokenTaggingIndex, "NER");
                }
                // If there is not a previous NER TokenTagging, a new one is created
                // and intializes with "O" tags for all tokens.
                else {
                    var tokenTagging = createTokenTagging("NER");
                    setAllTokenTagsToO(tokenization, tokenTagging);
                }
                addTokenTagging(tokenization, tokenTagging);
                for (var tokenIndex in tokenization.tokenList.tokenList) {
                    var tokenTag = getTaggedTokenWithIndex(tokenTagging,tokenIndex).tag;
                    // placeholder
                    var foo = tagSet.indexOf(tokenTag.split("-").pop());
                    var token_span = $('<span>')
                        .addClass(returnsCSSClassForTag(tokenTagging, tokenIndex))
                        .attr('data-tag-type-index', foo)
                        .attr('id', 'comm_' + commIndex + '_token_' + tokenIndex)
                        .css("background-color", tagColorPairs[foo])
                        .click({'commIndex': commIndex,
                                'tokenization': tokenization,
                                'tokenIndex': tokenIndex,
                                'tokenTagging': tokenTagging},
                               updateTagForNECallback)
                        .html(tokenization.tokenList.tokenList[tokenIndex].text + '<span class="tokenTag">(' + tokenTag +')</span>');
                    tokensDiv.append(token_span);
                    var token_whitespace = $('<span>').text(' ');
                    tokensDiv.append(token_whitespace);

                    // For each token, create an (initially empty) container where an
                    // NE label control can be displayed.
                    tokenTagInputsDiv.append(
                        $('<div>')
                            .attr('id', 'comm_' + commIndex + '_token_' + tokenIndex + '_ne_input_container'));
                    // Add NE label control for all "B" tokens and intializes with the correct value based on its tag.
                    if (tokenTag.charAt(0)=="B") {
                        addNEInputControl(commIndex, tokenization, tokenIndex, tokenTagging, tagSet);
                    }
                }
                var tokenTaggingDiv = $('<div>').addClass('token_tagging_container')
                                                .append(tokensDiv)
                                                .append(tokenTagInputsDiv);
                $('#tokenization_list').append(tokenTaggingDiv);
            }
        }
    }


    // Global variables
    var COMMS = [];
    var RESULTS_SERVER_SESSION_ID = null;

    $(document).ready(function(){
        CADET.init();


        for (var i = 0; i < tagSet.length; i++) {
            addTagTextBox(i);
        }
        $('#tag_type_list').after(
            $('<span>').addClass('glyphicon glyphicon-plus')
                       .css('cursor', 'pointer')
                       .on('click', function(event) {
                           tagSet.push('');
                           addTagTextBox(tagSet.length - 1);
                       }));

        var searchResultIdString = getUrlParameter('searchResultId');
        if (searchResultIdString) {
            var searchResultId = new UUID();
            searchResultId.uuidString = searchResultIdString;

            try {
                RESULTS_SERVER_SESSION_ID = CADET.results.startSession(searchResultId);
                var annotationUnitIdentifiers = CADET.results.getNextChunk(RESULTS_SERVER_SESSION_ID);
                COMMS = getNextCommunications(annotationUnitIdentifiers);
            }
            catch (error) {
                // TODO: Error handling
                throw error;
            }
        }
        else {
            // TODO: User-friendly error message about missing searchResultId
        }

        $('#save_button').on('click', function(event) {
            try {
                if (COMMS && COMMS.length > 0) {
                    for (var i = 0; i < COMMS.length; i++) {
                        CADET.results.submitAnnotation(
                            RESULTS_SERVER_SESSION_ID,
                            // The .annotationUnitIdentifier field is added by getNextCommunications()
                            COMMS[i].annotationUnitIdentifier,
                            COMMS[i]);
                    }
                }
                var annotationUnitIdentifiers = CADET.results.getNextChunk(RESULTS_SERVER_SESSION_ID);
                COMMS = getNextCommunications(annotationUnitIdentifiers);
                if (COMMS.length > 0) {
                    updateDisplayedCommunications(COMMS);
                }
                else {
                    location.replace("results.html");
                }
            }
            catch (error) {
            }
        });

        updateDisplayedCommunications(COMMS);
    });
    </script>
</head>
<body>
    <div class="container-fluid">

        <h4>
            <a href="index.html">Search</a> |
            <a href="results.html">Results</a>
        </h4>

        <hr />

        <div>
            <span id="tag_type_list"></span>
        </div>

        <hr />

        <div id="tokenization_list">
        </div>

        <hr />

        <div>
            <button class="btn btn-primary" id="save_button">Next</button>
        </div>

    </div><!-- /.container-fluid -->
</body>
</html>
