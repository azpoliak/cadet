<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Interface</title>
    <meta charset='UTF-8'>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="css/buttons.dataTables.min.css" rel="stylesheet">

    <script src="js/jquery-1.11.1.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/dataTables.buttons.min.js"></script>
    <script src="js/buttons.colVis.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/thrift.js"></script>
    <script src="js/concrete.js"></script>
    <script src="js/concrete-widgets.js"></script>
    <script src="js/concrete-services.js"></script>
    <script src="js/cadet.js"></script>

    <style>
    .container-fluid {
        margin-left: 1em;
        margin-right: 1em;
    }
    </style>

    <script>
    /* globals CADET */

    // Global variables
    var CONFIG_INFO_TABLE;


    function showSearchCapabilities() {
        var capabilities;
        try {
            capabilities = CADET.search.getCapabilities();
        }
        catch (error) {
            // TODO: Don't ignore error
            return;
        }
        for (var i = 0; i < capabilities.length; i++) {
            $('#capability_list').append(
                $('<li>').text(
                    CADET.getSearchTypeString(capabilities[i].type) + ': ' +
                    capabilities[i].lang));
        }
    }

    function showSearchCorpora() {
        var corpora;
        try {
            corpora = CADET.search.getCorpora();
        }
        catch (error) {
            // TODO: Don't ignore error
            return;
        }
        for (var i = 0; i < corpora.length; i++) {
            $('#corpora_list').append(
                $('<li>').text(corpora[i]));
        }
    }

    $(document).ready(function() {
        CADET.init();

        CONFIG_INFO_TABLE = $('#config_info_table').DataTable({
            columns: [
                {
                    title: 'Status',
                    data: 'status',
                    render: function(data, type, aliveStatus) {
                        if (aliveStatus) {
                            return '<span class="glyphicon glyphicon-ok" />';
                        }
                        else {
                            return '<span class="glyphicon glyphicon-remove" />';
                        }
                    },
                    width: '1%'
                },
                {
                    title: 'Service',
                    data: 'service'

                },
                {
                    title: 'Provider',
                    data: 'provider'
                },
                {
                    title: 'Provider Info',
                    data: 'providerInfo'
                },
                {
                    title: 'ServiceInfo',
                    data: 'serviceInfo'
                },
            ],
            dom: 'rti'
        });

        $.getJSON('AdminServlet', function(config) {
            var services = ['feedback', 'results', 'retrieve', 'search', 'send'];
            for (var i = 0; i < services.length; i++) {
                var serviceAlive;
                try {
                    CADET[services[i]].alive();
                    serviceAlive = true;
                }
                catch (error) {
                    serviceAlive = false;
                }

                var provider;
                var providerInfo;
                if (config.cadet[services[i]].hasOwnProperty('provider')) {
                    provider = config.cadet[services[i]].provider;
                    if (provider.includes('Remote') &&
                        config.cadet[services[i]].hasOwnProperty('host') &&
                        config.cadet[services[i]].hasOwnProperty('port'))
                    {
                        providerInfo = config.cadet[services[i]].host + ':' +
                                       config.cadet[services[i]].port;
                    }
                    else {
                        providerInfo = '';
                    }
                }
                else {
                    provider = 'N/A';
                    providerInfo = 'N/A';
                }

                var serviceInfoDetails;
                try {
                    var serviceInfo = CADET[services[i]].about();
                    serviceInfoDetails = serviceInfo.name + ' v' + serviceInfo.version;
                    if (serviceInfo.description) {
                        serviceInfoDetails += ': ' + serviceInfo.description;
                    }
                }
                catch (error) {
                    serviceInfoDetails = 'ERROR: ' + error.message;
                }

                CONFIG_INFO_TABLE.row.add({
                    'status': serviceAlive,
                    'service': services[i],
                    'provider': provider,
                    'providerInfo': providerInfo,
                    'serviceInfo': serviceInfoDetails
                });
            }
            CONFIG_INFO_TABLE.draw();
        });

        showSearchCapabilities();
        showSearchCorpora();
    });
    </script>
</head>
<body>
    <div class="container-fluid">
        <h4>
            <a href="index.html">Search</a> |
            <a href="results.html">Results</a>
        </h4>

        <hr />

        <h2>Service Info</h2>

        <div id="config_info">
            <table id="config_info_table" class="display"></table>
        </div>

        <hr />

        <h2>Search Info</h2>

        <h4>Capabilities</h4>
        <div>
            <ul id="capability_list"></ul>
        </div>

        <h4>Corpora:</h4>
        <div>
            <ul id="corpora_list"></ul>
        </div>

    </div><!-- /.container-fluid -->
</body>
